## Транспортный уровень

**Задача:** передача данных между процессами на разных хостах. Тут необходимо обеспечить **адресацию**, а также **надежность** передачи данных.

**Схема взаимодействия хостов:**

<div>
  <img width="580" height="325" src="src2/img1.png" alt="">
</div>

Для адресации данных используются **порты** - 1...65535
Три вида:
- хорошоизвестные (well-known ports): _0...1023_
- зарезервированные: _1024...49151_
- динамические: _49152...65535_

[Список портов](https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml)  


### Протокол UDP

_**UDP** (User Datagram Protocol)_ - протокол транспортного уровня

Сообщение протокола UDP называется дэйтаграммой. 

Протокол UDP обладает преимуществом - он достаточно быстрый, т.к. нет накладных расходов на установку соединения. Но не продоставляет дополнительного уровня надежности, поэтому ошибки должно обрабатывать приложение. 

Пример: Используется для указания порта отправителя и порта получателя.

**Формат протокола:**

<div>
  <img width="480" height="150" src="src2/img2.png" alt="">
</div>



### Протокол TCP

_**TCP** (Transmission Control Protocol)_ - протокол управления передачей. Обеспечивает надежную передачу данных. 

**Механика работы.** Поток байт от приложения разбивается на отдельные части -  сегменты, которые передаются поочередно от отправителя к получателю. Получатель собирает сегменты и передает принимающему приложению

<div>
  <img width="420" height="325" src="src2/img3.png" alt="">
</div>

**Нумерация байтов:**
<div>
  <img width="420" height="325" src="src2/img4.png" alt="">
</div>

**Дублирование байтов:**
<div>
  <img width="420" height="325" src="src2/img5.png" alt="">
</div>

#### Варианты подтверждения доставки

**Остановка и ожидание**
На каждую порцию данных отправляется подтверждение. Используется на канальном уровне

<div>
  <img width="230" height="225" src="src2/img6.png" alt="">
</div>

**Скользящее окно**
На несколько порций данных отправляется коммулятивное подтверждение. Обычно используется, когда между источником и приемником большое расстояние.

<div>
  <img width="250" height="225" src="src2/img7.png" alt="">
</div>

Размер окна - это количество байт данных, которые могут быть переданны без подтверждения

<div>
  <img width="550" height="225" src="src2/img8.png" alt="">
</div>


Есть два вида подтверждения:
- коммулятивное - подтверждение приема указанного байта данных и **всех предыдущих**. (используется по умолчанию)
- выборочное _(selective acknowledgment, SACK)_ - подтверждение диапозонов принятых байт

#### Соединение

В протоколе TCP для передачи данных необходимо установить соединение, а после разорвать. 

Задачи соединения:
- убедиться, что отправитель и получатель хотят передавать данные друг другу
- договориться о нумерации потока байт
- договориться о параметрах соединения (максимальный размер сегмента и тп)

Трехкратное рукопожатие:
1. SYN
2. SYN + ACK
3. ACK

<div>
  <img width="420" height="325" src="src2/img9.png" alt="">
</div>

**Корректный разрыв соединения**

<div>
  <img width="420" height="325" src="src2/img10.png" alt="">
</div>

При некорректном разрыве соединения посылается сообщение **RST**. 


#### Формат заголовка

![alt text](src2/img11.png)

_Порядковый номер_ - это порядковый первого байта сегмента
Для ethernet: 1460 (сегмент) + 20 (заголовок TCP) + 20 (заголовок IP) = 1500 байт
_Номер подтверждения_ - байт, который ожидается
_Параметры:_ MSS, масштаб окна, выборочное подтверждение, метки времени


#### Управление потоком

Т.к. в сети могут быть устройства разной производительности, то необходимо управлять потоком, чтобы избежать ситуации, когда быстрый отправитель отправляет много данных медленному получателю - _затопление_

Для решения проблемы используется поле **Размер окна**, в котором указывается сколько байт данных получатель может принять. Размер окна задается получателем и зависит от количества свободного места в буфере.

![alt text](src2/img12.png)

#### Управление перегрузкой

Т.к. в сеть может поступать большое количество пакетов, которое маршрутизаторы не способны обработать, то часть пакетов будет отбрасываться.

Окно перегрузки формируется отправителем и рассчитывается в зависимости от того, какая нагрузка на сеть. **Важно** определить оптимальный размер скользящего окна. Для этой цели используется метод аддитивного увеличения, мультипликативного уменьшения (_AIMD_). Суть метода заключается в том, что при получении каждого подтверждения мы прибавляем к размеру окна некоторое значение (обычно это размер одного сегмента), а если перегрузка произошла, тогда умножаем размер окна на некоторое значение (обычно 1/2 сегмента). Для быстрых сетей (современных) используется _медленный старт_ - размер окна увеличивается на 2..4 сегмента. 

В TCP обычно используется комбинированный метод - медленный старт + AIMD.
